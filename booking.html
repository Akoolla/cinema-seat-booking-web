<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Axbridge Roxy - Bookings</title>
<META HTTP-EQUIV="Pragma" CONTENT="no-cache">
<META HTTP-EQUIV="Expires" CONTENT="-1">
<link href="css/bootstrap.min.css" rel="stylesheet" />

<script src="js/jquery/jquery-1.11.2.min.js"></script>
<script src="js/jquery/jquery.form.min.js" charset="utf-8"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/validation.js"></script>
<script src="js/bookings.js"></script>

<script>
	var restService = "http://localhost:8080/";
	var wheelChairPrice1;
	var standardPrice;
	var concessionCost;
	
	var wheelChairSpaces;
	var standardSpaces;
	var concessionSpaces;

	$(function() {
		$("#nav").load("nav.html");
	});
	
	function bookingMade(data){
		$("#bookingForm").addClass("hidden");
		$("#bookingMade").removeClass("hidden");
		
		$("#screeningName").append(data.screeningName);
		$("#rating").append(data.screeningRating);
		$("#dateAndTime").append(data.screeningDateAndTime);
		$("#bookingRef").append(data.bookingRef);
		$("#bookedPrice").append(data.priceInPence/100);//TODO convert to pounds
	}

	$(document).ready(
			function() {
				$("#nav").load("nav.html");

				//Set-up add person form
				var options = {
					url : restService + 'screening/213123/book',
					dataType : 'jsonp',
					jsonp : 'json.wrf',
					type : 'post',
					clearForm : true,
					timeout : 3000,
					success: bookingMade
				};

				$('#makeBooking').ajaxForm(options);

				$("#email").on(
						"change",
						function() {
							$("#emailIcon").removeClass("hidden").removeClass(
									"glyphicon-ok").removeClass(
									"glyphicon-remove");
							if (validateEmail($(this).val())) {
								$("#emailGrp").removeClass("has-error")
										.addClass("has-success");
								$("#emailIcon").addClass("glyphicon-ok");
							} else {
								$("#emailGrp").removeClass("has-success")
										.addClass("has-error");
								$("#emailIcon").addClass("glyphicon-remove");
							}
							updateBookingState();
						});
				
				$("#bookedName").on(
						"change",
						function() {
							$("#bookedNameIcon").removeClass("hidden").removeClass(
									"glyphicon-ok").removeClass(
									"glyphicon-remove");
							if (validateAsName($(this).val())) {
								$("#bookedNameGrp")
										.removeClass("has-error")
										.addClass("has-success");
								$("#bookedNameIcon").addClass("glyphicon-ok");
							} else {
								$("#bookedNameGrp")
										.removeClass("has-success")
										.addClass("has-error");
								$("#bookedNameIcon")
										.addClass("glyphicon-remove");
							}
							updateBookingState();
						});
				
				$("#standard").on("change", function(){ validateSeats(); updateTotalCost(); updateBookingState(); });
				$("#wheelchairs").on("change", function(){ validateSeats(); updateTotalCost(); updateBookingState(); });
				$("#concessions").on("change", function(){ validateSeats(); updateTotalCost(); updateBookingState(); });
				
				loadScreening();
				});
	
	function loadScreening(){
		$.ajax({
			'url' : restService + 'screening/2131',
			'success' : function(data) {
				populateScreeningData(data);
			},
			'dataType' : 'jsonp',
			'jsonp' : 'json.wrf'
		});
	}
	
	//Enables booking to be completed from form	
	function updateBookingState(){
		var fieldsAreValid = true;
		fieldsAreValid = validateEmail($("#email").val());
		fieldsAreValid = fieldsAreValid & validateAsName($("#bookedName").val());
		
		if(fieldsAreValid){
			var seats = 0;
			if($("#standard").val().length > 0){
				seats = seats + parseInt($("#standard").val());
			}
						
			if($("#concessions").val().length > 0){
				seats = seats + parseInt($("#concessions").val());
			}
		
			if($("#wheelchairs").val().length > 0){
				seats = seats + parseInt($("#wheelchairs").val());
			}

			fieldsAreValid = fieldsAreValid & seats > 0;
		}
		
		if(fieldsAreValid){
			$("#bookBtn").removeClass("disabled");
		} else {
			$("#bookBtn").addClass("disabled");
		}
	}

	
	function validateSeats(){
		var standardSeatsToBook = 0;
		var wheelChairsToBook = 0;
		
		standardSeatsToBook = standardSeatsToBook + parseInt(($.isNumeric($("#standard").val()) ? $("#standard").val() : 0));
		standardSeatsToBook = standardSeatsToBook + parseInt(($.isNumeric($("#concessions").val()) ? $("#concessions").val() : 0));
		wheelChairsToBook = wheelChairsToBook + parseInt(($.isNumeric($("#wheelchairs").val()) ? $("#wheelchairs").val() : 0));
		
		var standardValid = ($("#standard").val().length === 0 || $.isNumeric($("#standard").val())) && standardSeatsToBook <= standardSpaces;
		var concessionsValid =  ($("#concessions").val().length === 0 || $.isNumeric($("#concessions").val())) && standardSeatsToBook <= standardSpaces;
		var wheelChairsValid = ($("#wheelchairs").val().length === 0 || $.isNumeric($("#wheelchairs").val())) && wheelChairsToBook <= wheelChairSpaces;
		
		setValidityOfSeat(standardValid, "standard");
		setValidityOfSeat(concessionsValid, "concessions");
		setValidityOfSeat(wheelChairsValid, "wheelchairs");
		
		return standardValid & concessionsValid & wheelChairsValid;
	}
	
	function updateTotalCost(){
		var totalCost = 0;

		if($.isNumeric($("#standard").val())){
			totalCost = totalCost + (parseInt($("#standard").val()) * standardPrice);
		}
		if($.isNumeric($("#wheelchairs").val())){
			totalCost = totalCost + (parseInt($("#wheelchairs").val()) * wheelChairPrice);
		}
		if($.isNumeric($("#concessions").val())){
			totalCost = totalCost + (parseInt($("#concessions").val()) * concessionCost);
		}

		pence = totalCost % 100;
		pounds = (totalCost / 100) - (pence/100);
		
		$("#costPounds").val(pounds);
		$("#costPence").empty();
		$("#costPence").append("." + pence);
	}
	
	function setValidityOfSeat(isValid, idPrefix){
		var lengthGreateThanZero = $("#" + idPrefix).val().length > 0;
		var hasNonZeroValue = lengthGreateThanZero & parseInt($("#" + idPrefix).val()) > 0;
		
		$("#" + idPrefix + "Grp")
			.removeClass("has-error")
			.removeClass("has-success");
		
		$("#" + idPrefix + "Icon")
			.removeClass("hidden")
			.removeClass("glyphicon-ok")
			.removeClass("glyphicon-remove");
				
		if(hasNonZeroValue){
			if(isValid){
				$("#" + idPrefix + "Grp").removeClass("has-error").addClass("has-success");
				$("#" + idPrefix + "Icon").addClass("glyphicon-ok");
			} else {
				$("#" + idPrefix + "Grp").removeClass("has-success").addClass("has-error");
				$("#" + idPrefix + "Icon").addClass("glyphicon-remove");
			}
		}
	}
	
	function populateScreeningData(data){
		wheelChairPrice = data.screening.wheelChairPrice;
		standardPrice = data.screening.standardPrice;
		concessionCost = data.screening.concessionCost;
		
		wheelChairSpaces = data.screening.wheelChairSpaces;
		standardSpaces = data.screening.standardSpaces;
	}
</script>
</head>
<body>
	<div id="nav"></div>
	<div class="container">
		<div class="hidden alert alert-success" role="alert" id="bookingMade">
			<div class="row">
				<div class="col-md-12">
					<p>
					Your Booking has been made for <strong><span id="screeningName"></span>
					<span id="rating"></span>
					&nbsp;<span id="dateAndTime"></span></strong>
					</p>
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
					<p>Booking reference is <strong id="bookingRef">32123213213</strong></p>
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
					<p>Total Price is <strong>£<span id="bookedPrice"></span></strong></p>
				</div>
			</div>
		</div>
		<div class="col-md-4" id="bookingForm">
			<form class="form-horizontal" id="makeBooking" method="post">
				<div class="form-group">
					<label>Booking for:</label>
					<p class="form-control-static">What We Do In The Shadows (15) -
						Friday, Apr 1st 8:30pm</p>
				</div>
				
				<div class="form-group has-feedback" id="bookedNameGrp">
					<label for="bookedName" class="control-label">Name</label> <input
						class="form-control" type="text"
						placeholder="Please enter email address" id="bookedName" name="bookedName"
						aria-describedby="bookedNameSuccessStatus"> <span
						class="glyphicon glyphicon-ok form-control-feedback hidden"
						aria-hidden="true" id="bookedNameIcon"></span> <span
						id="bookedNameSuccessStatus" class="sr-only">(success)</span>
				</div>
				
				<div class="form-group has-feedback" id="emailGrp">
					<label for="email" class="control-label">Email</label> <input
						class="form-control" type="text"
						placeholder="Please enter email address" id="email" name="email"
						aria-describedby="emailSuccessStatus"> <span
						class="glyphicon glyphicon-ok form-control-feedback hidden"
						aria-hidden="true" id="emailIcon"></span> <span
						id="emailSuccessStatus" class="sr-only">(success)</span>
				</div>

				<div class="form-group">
					<div class="checkbox">
						<label> <input type="checkbox" value="true" id="isMember"> Tick if a
							member
						</label>
					</div>
				</div>


				<div class="form-group has-feedback" id="standardGrp">
					<label for="standard" class="control-label">Number of Standard Seats</label> <input
						class="form-control" type="text" 
						placeholder="0" id="standard" name="standard" 
						aria-describedby="standardSuccessStatus"> <span 
						class="glyphicon glyphicon-ok form-control-feedback hidden"
						aria-hidden="true" id="standardIcon"></span> 
						<span id="standardSuccessStatus" class="sr-only">(success)</span>
				</div>

				<div class="form-group has-feedback" id="concessionsGrp">
					<label for="concessions" class="control-label">Number of Concession Seats</label> <input
						class="form-control" type="text" 
						placeholder="0" id="concessions" name="concessions" 
						aria-describedby="concessionsSuccessStatus"> <span 
						class="glyphicon glyphicon-ok form-control-feedback hidden"
						aria-hidden="true" id="concessionsIcon"></span> 
						<span id="concessionsSuccessStatus" class="sr-only">(success)</span>
				</div>
				
				<div class="form-group has-feedback" id="wheelchairsGrp">
					<label for="wheelchairs" class="control-label">Number of Wheelchairs</label> <input
						class="form-control" type="text" 
						placeholder="0" id="wheelchairs" name="wheelchairs" 
						aria-describedby="wheelchairsSuccessStatus"> <span 
						class="glyphicon glyphicon-ok form-control-feedback hidden"
						aria-hidden="true" id="wheelchairsIcon"></span> 
						<span id="wheelchairsSuccessStatus" class="sr-only">(success)</span>
				</div>

				<div class="row">
					<div class="col-xs-6">
						<div class="form-group">
							<label class="sr-only" for="exampleInputAmount">0
								(in pounds)</label>
							<div class="input-group">
								<div class="input-group-addon">£</div>
								<input type="text" class="form-control" id="costPounds"
									placeholder="0" readonly>
								<div class="input-group-addon" id="costPence">.00</div>
							</div>
						</div>
					</div>
					<div class="col-xs-6">
						<button type="submit" class="btn btn-primary disabled" id="bookBtn">Book Seats</button>
					</div>
				</div>
			</form>
		</div>
	</div>
</body>
</html>
